version: 2

models:
  - name: daily_active_users
    description: "Daily active user metrics with engagement breakdown and growth indicators"
    columns:
      - name: activity_date
        description: "Date of activity"
        tests:
          - not_null
          - unique
      - name: daily_active_users
        description: "Count of unique users with any activity on this date"
        tests:
          - not_null
      - name: ai_active_users
        description: "Count of users who used AI features on this date"
      - name: dau_7day_avg
        description: "7-day rolling average of daily active users"
      - name: dau_wow_growth_percent
        description: "Week-over-week growth percentage"
      - name: ai_adoption_rate
        description: "Percentage of DAU who used AI features"

  - name: user_acquisition_funnel
    description: "User acquisition and onboarding funnel analysis by signup date"
    columns:
      - name: signup_date
        description: "Date of user signup"
        tests:
          - not_null
          - unique
      - name: signups
        description: "Number of new signups on this date"
      - name: onboarding_completion_rate
        description: "Percentage who completed onboarding"
      - name: ai_adoption_rate
        description: "Percentage who used AI features (ever)"
      - name: week_1_activation_rate
        description: "Percentage active in first week after signup"

  - name: dextr_performance
    description: "AI system performance and user satisfaction metrics"
    columns:
      - name: query_date
        description: "Date of AI queries"
        tests:
          - not_null
          - unique
      - name: total_queries
        description: "Total AI queries on this date"
      - name: avg_like_rate
        description: "Average like rate for AI-generated content"
      - name: pack_success_rate
        description: "Percentage of queries that resulted in successful packs"
      - name: avg_processing_time
        description: "Average AI response time in seconds"
      - name: power_user_percentage
        description: "Percentage of users making 6+ queries"

  - name: content_performance
    description: "Content performance across all card types and sources"
    columns:
      - name: metric_type
        description: "Type of metric: individual_cards or category_performance"
      - name: card_id
        description: "Unique card identifier (for individual cards)"
      - name: card_type
        description: "Type of card: experience or featured"
      - name: like_rate
        description: "Percentage of swipes that were positive"
      - name: conversion_rate
        description: "Percentage of impressions that led to conversion actions"
      - name: engagement_score
        description: "Weighted engagement score based on action values"

  - name: executive_summary
    description: "High-level executive dashboard with key business metrics"
    columns:
      - name: report_date
        description: "Date this report was generated"
        tests:
          - not_null
      - name: daily_active_users
        description: "Average DAU in last 30 days"
      - name: dau_growth_percent
        description: "Average week-over-week DAU growth"
      - name: week_1_retention_rate
        description: "Average week 1 retention rate"
      - name: ai_satisfaction_rate
        description: "Average AI feature satisfaction rate"
      - name: overall_health_score
        description: "Composite business health score (0-100)"
      - name: growth_health
        description: "Qualitative growth assessment"
      - name: ai_health
        description: "Qualitative AI feature health assessment"

  - name: user_cohort_retention_monthly
    description: "Monthly cohort retention analysis showing how users return over months"
    columns:
      - name: cohort_month
        description: "Month when the cohort of users signed up"
        tests:
          - not_null
      - name: cohort_size
        description: "Total number of users who signed up in this cohort month"
        tests:
          - not_null
      - name: months_since_signup
        description: "Number of months since the cohort signed up (0 = signup month)"
      - name: month_label
        description: "Human-readable label for the month (e.g., 'Month 1', 'Month 3')"
      - name: users_active
        description: "Number of users from this cohort who were active in this month"
      - name: retention_rate
        description: "Percentage of cohort users who were active (0-100)"
      - name: cohort_quarter
        description: "Quarter of cohort signup for grouping"
      - name: cohort_year
        description: "Year of cohort signup for grouping"

  - name: user_segmentation
    description: "Customer segmentation model identifying 'Planners' (users who actively initiate planning) vs 'Passengers' (passive engagers). Critical for retention strategies."
    columns:
      - name: user_id
        description: "Unique user identifier"
        tests:
          - not_null
          - unique
      - name: email
        description: "User email address"
      - name: username
        description: "User's display username"
      - name: full_name
        description: "User's full name"
      - name: created_at
        description: "Timestamp when user account was created"
        tests:
          - not_null
      - name: user_type
        description: "Segmentation classification: 'Planner' (actively initiates planning) or 'Passenger' (passive engager)"
        tests:
          - not_null
          - accepted_values:
              values: ['Planner', 'Passenger']
      - name: planner_criteria_met
        description: "Array of criteria that qualified user as Planner: ['prompt_and_swipe', 'created_deck', 'shared_content', 'created_multiplayer']"
      - name: total_prompts
        description: "Total number of Dextr AI prompts submitted by user"
      - name: total_swipes
        description: "Total number of card swipes (both left and right) across all sources"
      - name: total_saves
        description: "Total number of cards saved to boards"
      - name: total_shares
        description: "Total number of shares (decks or cards) across all sources"
      - name: total_decks_created
        description: "Total number of non-default boards/decks created by user"
      - name: total_multiplayer_sessions_created
        description: "Total number of multiplayer planning sessions initiated by user"
      - name: total_multiplayer_sessions_participated
        description: "Total number of multiplayer sessions user participated in (including as creator)"
      - name: total_referrals_given
        description: "Total number of referrals given by user (number of users who used this user's referral code)"
      - name: total_conversions
        description: "Total conversion actions: opened_website, book_with_deck, click_directions, click_phone"
      - name: days_active
        description: "Number of distinct days user had any activity"
      - name: last_activity_date
        description: "Date of user's most recent activity"
      - name: days_since_signup
        description: "Number of days since user account was created"
      - name: days_since_last_activity
        description: "Number of days since user's last activity (NULL if never active)"
      - name: is_test_user
        description: "Boolean flag indicating if user is a test account (should be 0, as test users are excluded)"
      - name: prompts_per_active_day
        description: "Average number of AI prompts per active day (total_prompts / days_active)"
      - name: swipes_per_prompt
        description: "Average number of swipes per AI prompt (total_swipes / total_prompts)"
      - name: conversion_rate
        description: "Percentage of swipes that led to conversion actions (total_conversions / total_swipes * 100)"

  - name: user_segmentation_summary
    description: "High-level summary of Planners vs Passengers segmentation with key metrics and comparisons"
    columns:
      - name: total_users
        description: "Total number of users in the system (excluding test users)"
      - name: total_planners
        description: "Total number of users classified as Planners"
      - name: total_passengers
        description: "Total number of users classified as Passengers"
      - name: planner_percentage
        description: "Percentage of total users who are Planners"
      - name: planner_activation_rate
        description: "Percentage of Planners with at least 1 day of activity"
      - name: passenger_activation_rate
        description: "Percentage of Passengers with at least 1 day of activity"
      - name: planner_avg_prompts_per_active_day
        description: "Average AI prompts per active day for Planners"
      - name: planner_avg_conversion_rate
        description: "Average conversion rate for Planners"
      - name: planners_via_prompt_swipe
        description: "Number of Planners who qualified via prompt + swipe criteria"
      - name: planners_via_deck
        description: "Number of Planners who created at least one deck"
      - name: planners_via_share
        description: "Number of Planners who shared content"
      - name: planners_via_multiplayer
        description: "Number of Planners who created multiplayer sessions"
      - name: planner_vs_passenger_prompt_ratio
        description: "Ratio of Planner to Passenger average prompts per active day"
      - name: report_generated_at
        description: "Timestamp when this summary was generated"

  - name: dextr_query_user_performance
    description: "Dextr query performance analysis by user. One row per query showing all card-level interactions and performance metrics."
    columns:
      - name: date
        description: "Date when the query was made"
        tests:
          - not_null
      - name: user_id
        description: "ID of the user who made the query"
        tests:
          - not_null
      - name: user_name
        description: "Username of the person who made the query"
      - name: user_email
        description: "Email of the user who made the query"
      - name: user_type
        description: "User segment: Planner or Passenger"
      - name: query_id
        description: "Unique identifier for the Dextr query"
        tests:
          - not_null
          - unique
      - name: query_text
        description: "The actual query text submitted by the user"
      - name: query_timestamp
        description: "Timestamp when the query was submitted"
      - name: processing_time
        description: "Time taken to process the query (in seconds)"
      - name: query_context
        description: "Full query context as JSONB (location, session_id, app_version)"
      - name: location
        description: "Location from query context (typically 'London')"
      - name: app_version
        description: "App version from query context"
      - name: session_id
        description: "Session ID from query context"
      - name: pack_id
        description: "ID of the pack/recommendations generated for this query"
      - name: total_cards_in_pack
        description: "Total number of cards in the generated pack"
      - name: cards_viewed
        description: "Number of cards shown to the user (shown_to_user = true)"
      - name: cards_liked
        description: "Number of cards the user swiped right on"
      - name: cards_disliked
        description: "Number of cards the user swiped left on"
      - name: cards_saved
        description: "Number of cards the user saved from this pack"
      - name: like_rate
        description: "Percentage of viewed cards that were liked (cards_liked / cards_viewed * 100)"
      - name: save_rate
        description: "Percentage of viewed cards that were saved (cards_saved / cards_viewed * 100)"
      - name: view_completion_rate
        description: "Percentage of pack cards that were viewed (cards_viewed / total_cards_in_pack * 100)"
      - name: query_engaged
        description: "Binary flag: 1 if user viewed any cards, 0 otherwise"
      - name: query_had_likes
        description: "Binary flag: 1 if user liked any cards, 0 otherwise"
      - name: query_had_saves
        description: "Binary flag: 1 if user saved any cards, 0 otherwise"

  # ============================================
  # NORTH STAR METRICS MODELS
  # ============================================

  - name: north_star_session_metrics
    description: "Per-session North Star metrics and flags. Foundation for weekly aggregations, funnel analysis, and activation tracking."
    columns:
      - name: derived_session_id
        description: "Unique session identifier derived from user_id + session_number + timestamp"
        tests:
          - not_null
          - unique
      - name: user_id
        description: "User who had this session"
        tests:
          - not_null
      - name: session_week
        description: "Week of the session (Monday start)"
      - name: primary_surface
        description: "Primary entry point for session: prompt, featured, multiplayer, board, other"
      - name: is_planning_session
        description: "Boolean: session had planning initiation (prompt, featured browse, multiplayer join)"
      - name: has_save
        description: "Boolean: session had at least 1 save"
      - name: is_ssr
        description: "Boolean: same as has_save, indicates Session Save Rate qualification"
      - name: is_scr3
        description: "Boolean: session had 3+ unique saves (Session Conversion Rate 3+)"
      - name: unique_saves
        description: "Count of unique cards saved in session"
      - name: ttfs_seconds
        description: "Time to First Save in seconds (null if no save)"
      - name: has_card_share
        description: "Boolean: session had card-level share (NOT deck shares - those aren't tracked)"
      - name: has_multiplayer_activity
        description: "Boolean: session had multiplayer create or join"
      - name: has_conversion
        description: "Boolean: session had conversion action (booking, directions, website)"
      - name: session_outcome
        description: "Categorical outcome: full_loop, save_and_multiplayer, save_and_share, save_only, share_only, multiplayer_only, no_value"

  - name: north_star_weekly
    description: "Weekly aggregated North Star metrics. Primary reporting model for SSR, SCR3, WAP, TTFS."
    columns:
      - name: session_week
        description: "Week start date (Monday)"
        tests:
          - not_null
          - unique
      - name: planning_sessions
        description: "Count of planning sessions (sessions with planning initiation)"
      - name: ssr
        description: "Session Save Rate: % of planning sessions with at least 1 save"
      - name: scr3
        description: "Session Conversion Rate 3+: % of planning sessions with 3+ saves"
      - name: wap
        description: "Weekly Active Planners: unique users with save or multiplayer activity"
      - name: median_ttfs_seconds
        description: "Median Time to First Save among sessions with saves"
      - name: multiplayer_activity_rate
        description: "% of planning sessions with multiplayer activity"
      - name: nvr
        description: "No Value Rate: % of planning sessions with no save, share, or multiplayer"
      - name: sessions_wow_growth
        description: "Week-over-week growth in total sessions (%)"

  - name: north_star_by_surface
    description: "North Star metrics broken down by primary surface (prompt, featured, multiplayer, board, other)."
    columns:
      - name: session_week
        description: "Week start date (Monday)"
        tests:
          - not_null
      - name: primary_surface
        description: "Entry point surface: prompt, featured, multiplayer, board, other"
        tests:
          - not_null
      - name: total_sessions
        description: "Planning sessions from this surface"
      - name: ssr_percent
        description: "Session Save Rate for this surface"
      - name: scr3_percent
        description: "Session Conversion Rate 3+ for this surface"
      - name: avg_saves_per_saver
        description: "Average saves among sessions that saved"
      - name: median_ttfs_seconds
        description: "Median Time to First Save for this surface"

  - name: north_star_save_analysis
    description: "Save source breakdown and deduplication analysis. Tracks saves from core_card_actions vs board_places."
    columns:
      - name: save_week
        description: "Week of the save"
        tests:
          - not_null
      - name: save_source
        description: "Source: direct_save (from card action) or board_add (from board_places)"
      - name: save_count
        description: "Number of saves from this source"
      - name: unique_savers
        description: "Distinct users who saved via this source"
      - name: pct_of_total_saves
        description: "This source as % of total week saves"
      - name: users_using_both_sources
        description: "Users who saved via both direct and board methods this week"

  - name: north_star_multiplayer_analysis
    description: "Multiplayer engagement analysis. Treated as its own feature, NOT as a share proxy."
    columns:
      - name: metric_week
        description: "Week of the metrics"
        tests:
          - not_null
          - unique
      - name: sessions_created
        description: "Total multiplayer sessions created"
      - name: true_multiplayer_sessions
        description: "Sessions that achieved 2+ participants (true collaboration)"
      - name: collaboration_rate
        description: "% of created sessions that became true multiplayer"
      - name: avg_participants
        description: "Average participants in true multiplayer sessions"
      - name: sessions_with_voting
        description: "Sessions where participants voted"
      - name: voting_rate
        description: "% of true multiplayer sessions with voting"
      - name: clear_consensus_rate
        description: "% of sessions reaching clear consensus"
      - name: ai_source_rate
        description: "% of sessions initiated from AI prompt"
      - name: joins_per_session
        description: "Average joins per session created (virality indicator)"

  - name: north_star_session_funnel
    description: "Session funnel analysis showing drop-off at each stage from initiation to conversion."
    columns:
      - name: session_week
        description: "Week of the funnel data"
        tests:
          - not_null
          - unique
      - name: initiated
        description: "Stage 1: Planning sessions started"
      - name: browsed
        description: "Stage 2: Sessions with engagement beyond start"
      - name: engaged
        description: "Stage 3: Sessions with positive action (swipe/view)"
      - name: saved
        description: "Stage 4: Sessions with at least 1 save (SSR)"
      - name: shortlisted
        description: "Stage 5: Sessions with 3+ saves (SCR3)"
      - name: social
        description: "Stage 6: Sessions with share or multiplayer"
      - name: converted
        description: "Stage 7: Sessions with conversion action"
      - name: pct_saved
        description: "% of initiated that reached saved stage"
      - name: cvr_engaged_to_saved
        description: "Stage-to-stage conversion from engaged to saved"
      - name: drop_engaged
        description: "Drop-off % at engaged stage"

  - name: north_star_activation
    description: "User activation and retention analysis by signup cohort. Activation = first save within 7 days."
    columns:
      - name: cohort_week
        description: "Week users signed up"
        tests:
          - not_null
          - unique
      - name: cohort_size
        description: "Number of users in this signup cohort"
      - name: activated_7d
        description: "Users who saved within 7 days of signup"
      - name: activation_rate_7d
        description: "% of cohort who activated within 7 days"
      - name: activated_with_scr3
        description: "Users who reached SCR3 (3+ saves) in first week"
      - name: strong_activation_rate
        description: "% of cohort with SCR3 in first week"
      - name: median_days_to_activation
        description: "Median days from signup to first save"
      - name: retention_d7
        description: "% of all users with activity after first week"
      - name: activated_retention_d7
        description: "% of activated users with activity after first week"
      - name: avg_saves_week1
        description: "Average saves per user in first week"