version: 2

models:
  - name: vis_daily_active_users
    description: "Daily active user metrics with engagement breakdown and growth indicators"
    columns:
      - name: activity_date
        description: "Date of activity"
      - name: daily_active_users
        description: "Count of unique users with any activity on this date"
      - name: ai_active_users
        description: "Count of users who used AI features on this date"
      - name: dau_7day_avg
        description: "7-day rolling average of daily active users"
      - name: dau_wow_growth_percent
        description: "Week-over-week growth percentage"
      - name: ai_adoption_rate
        description: "Percentage of DAU who used AI features"

  - name: vis_user_acquisition_funnel
    description: "User acquisition and onboarding funnel analysis by signup date"
    columns:
      - name: signup_date
        description: "Date of user signup"
      - name: signups
        description: "Number of new signups on this date"
      - name: onboarding_completion_rate
        description: "Percentage who completed onboarding"
      - name: ai_adoption_rate
        description: "Percentage who used AI features (ever)"
      - name: week_1_activation_rate
        description: "Percentage active in first week after signup"

  - name: vis_dextr_performance
    description: "AI system performance and user satisfaction metrics"
    columns:
      - name: query_date
        description: "Date of AI queries"
      - name: total_queries
        description: "Total AI queries on this date"
      - name: avg_like_rate
        description: "Average like rate for AI-generated content"
      - name: pack_success_rate
        description: "Percentage of queries that resulted in successful packs"
      - name: avg_processing_time
        description: "Average AI response time in seconds"
      - name: power_user_percentage
        description: "Percentage of users making 6+ queries"

  - name: vis_content_performance
    description: "Content performance across all card types and sources"
    columns:
      - name: metric_type
        description: "Type of metric: individual_cards or category_performance"
      - name: card_id
        description: "Unique card identifier (for individual cards)"
      - name: card_type
        description: "Type of card: experience or featured"
      - name: like_rate
        description: "Percentage of swipes that were positive"
      - name: conversion_rate
        description: "Percentage of impressions that led to conversion actions"
      - name: engagement_score
        description: "Weighted engagement score based on action values"

  - name: vis_executive_summary
    description: "High-level executive dashboard with key business metrics"
    columns:
      - name: report_date
        description: "Date this report was generated"
      - name: daily_active_users
        description: "Average DAU in last 30 days"
      - name: dau_growth_percent
        description: "Average week-over-week DAU growth"
      - name: week_1_retention_rate
        description: "Average week 1 retention rate"
      - name: ai_satisfaction_rate
        description: "Average AI feature satisfaction rate"
      - name: overall_health_score
        description: "Composite business health score (0-100)"
      - name: growth_health
        description: "Qualitative growth assessment"
      - name: ai_health
        description: "Qualitative AI feature health assessment"

  - name: vis_dextr_query_user_performance
    description: "Dextr query performance analysis by user. One row per query showing all card-level interactions and performance metrics."
    columns:
      - name: date
        description: "Date when the query was made"
      - name: user_id
        description: "ID of the user who made the query"
      - name: user_name
        description: "Username of the person who made the query"
      - name: user_email
        description: "Email of the user who made the query"
      - name: user_type
        description: "User segment: Planner or Passenger"
      - name: query_id
        description: "Unique identifier for the Dextr query"
      - name: query_text
        description: "The actual query text submitted by the user"
      - name: query_timestamp
        description: "Timestamp when the query was submitted"
      - name: processing_time
        description: "Time taken to process the query (in seconds)"
      - name: query_context
        description: "Full query context as JSONB (location, session_id, app_version)"
      - name: location
        description: "Location from query context (typically 'London')"
      - name: app_version
        description: "App version from query context"
      - name: session_id
        description: "Session ID from query context"
      - name: pack_id
        description: "ID of the pack/recommendations generated for this query"
      - name: total_cards_in_pack
        description: "Total number of cards in the generated pack"
      - name: cards_viewed
        description: "Number of cards shown to the user (shown_to_user = true)"
      - name: cards_liked
        description: "Number of cards the user swiped right on"
      - name: cards_disliked
        description: "Number of cards the user swiped left on"
      - name: cards_saved
        description: "Number of cards the user saved from this pack"
      - name: like_rate
        description: "Percentage of viewed cards that were liked (cards_liked / cards_viewed * 100)"
      - name: save_rate
        description: "Percentage of viewed cards that were saved (cards_saved / cards_viewed * 100)"
      - name: view_completion_rate
        description: "Percentage of pack cards that were viewed (cards_viewed / total_cards_in_pack * 100)"
      - name: query_engaged
        description: "Binary flag: 1 if user viewed any cards, 0 otherwise"
      - name: query_had_likes
        description: "Binary flag: 1 if user liked any cards, 0 otherwise"
      - name: query_had_saves
        description: "Binary flag: 1 if user saved any cards, 0 otherwise"

  - name: fct_session_outcomes
    description: "Core fact table for session-level North Star metric analysis. Each row is a planning session with outcome flags for PSR ladder."
    columns:
      - name: session_id
        description: "Unique session identifier (native or inferred)"
      - name: user_id
        description: "User who owned this session"
      - name: session_date
        description: "Date the session started"
      - name: session_week
        description: "Week the session started (for weekly cohorts)"
      - name: data_source
        description: "Whether session is 'native' (from planning_sessions) or 'inferred' (from event timestamps)"
      - name: has_save
        description: "TRUE if session had at least 1 save"
      - name: has_share
        description: "TRUE if session had at least 1 share"
      - name: has_post_share_interaction
        description: "TRUE if shared session received non-sharer interaction within 24h"
      - name: meets_psr_broad
        description: "Plan Survival Rate (Broad): % sessions with save AND share"
      - name: meets_psr_strict
        description: "Plan Survival Rate (Strict): includes post-share interaction"
      - name: is_no_value_session
        description: "TRUE if session had neither saves nor shares"
      - name: time_to_first_save_seconds
        description: "Seconds from session start to first save"
      - name: time_to_first_share_seconds
        description: "Seconds from session start to first share"
      - name: intent_strength
        description: "Intent classification: 'strong' (dextr/search) or 'weak'"
      - name: app_version
        description: "App version from dextr query context (inferred sessions) or null (native)"
      - name: effective_app_version
        description: "Coalesce of native app_version and date-imputed version from app_version_releases seed. Always populated."
      - name: share_attribution_confidence
        description: "Confidence in share attribution: 'high' (native), 'medium' (card share with pack_id), 'low' (share_link time-window match)"
      - name: is_genuine_planning_attempt
        description: "TRUE if session had at least one prompt (dextr_query), save, or share. Filters out sessions with only browsing/impression activity."

  - name: fct_north_star_daily
    description: "Daily aggregate North Star metrics with rates, rolling averages, and WoW changes"
    columns:
      - name: metric_date
        description: "Date of metrics"
      - name: data_source
        description: "Filter: 'all', 'native', or 'inferred'"
      - name: session_type
        description: "Filter: 'all', 'prompt', or 'non_prompt'"
      - name: app_version
        description: "Filter: 'all', specific version, or 'unknown'"
      - name: ssr
        description: "Session Save Rate: % sessions with at least 1 save"
      - name: shr
        description: "Session Share Rate: % sessions with at least 1 share"
      - name: psr_broad
        description: "Plan Survival Rate (Broad): % sessions with save AND share"
      - name: psr_strict
        description: "Plan Survival Rate (Strict): includes post-share interaction"
      - name: nvr
        description: "No Value Rate: % sessions with 0 saves and 0 shares"
      - name: attribution_rate
        description: "Data quality: % sessions with native session_id"
      - name: psr_broad_7d_avg
        description: "7-day rolling average of PSR Broad"
      - name: ssr_wow_change
        description: "Week-over-week change in SSR"
      - name: psr_broad_wow_change
        description: "Week-over-week change in PSR Broad"

  - name: fct_north_star_weekly
    description: "Weekly aggregate North Star metrics with WAP calculations"
    columns:
      - name: metric_week
        description: "Week start date"
      - name: app_version
        description: "Filter: 'all', specific version, or 'unknown'"
      - name: weekly_active_planners
        description: "Unique users with at least 1 save or share this week"
      - name: psr_broad
        description: "Plan Survival Rate (Broad) for the week"

  - name: fct_activation_funnel
    description: "User-level activation tracking within 7/30 day windows of signup"
    columns:
      - name: user_id
        description: "Unique user identifier"
      - name: signup_date
        description: "User signup date"
      - name: has_planning_initiation_7d
        description: "F1: Had planning initiation within 7 days"
      - name: has_activation_7d
        description: "F2: Activated (save or share) within 7 days"
      - name: has_first_share_7d
        description: "F3: Shared at least once within 7 days"
      - name: has_first_validation_7d
        description: "F4: Share received interaction within 7 days"
      - name: activation_type
        description: "Type of activation: save_only, share_only, or save_and_share"

  - name: fct_retention_activated
    description: "Retention analysis on activated users with D7/D30/D60 retention flags"
    columns:
      - name: user_id
        description: "Unique user identifier"
      - name: activation_date
        description: "Date user first activated"
      - name: had_activity_d7
        description: "Had meaningful activity (prompt, save, or share) within 7 days of activation"
      - name: had_activity_d30
        description: "Had meaningful activity (prompt, save, or share) within 30 days of activation"
      - name: had_activity_d60
        description: "Had meaningful activity (prompt, save, or share) within 60 days of activation"
      - name: is_mature_d7
        description: "TRUE if enough time has passed to measure D7 retention"

  - name: fct_active_planners
    description: "Weekly and monthly active planner counts with stickiness ratio"
    columns:
      - name: period_type
        description: "Period granularity: week or month"
      - name: period_start
        description: "Start date of the period"
      - name: active_planners
        description: "Unique users with at least 1 save or share in period"
      - name: planner_stickiness
        description: "avg(WAP) / MAP ratio (monthly only)"

  - name: fct_session_explorer
    description: "One row per session with JSONB detail columns for diagnostic exploration. Includes prompt texts, cards generated, saves, shares, and event timelines."
    columns:
      - name: session_id
        description: "Unique session identifier (native or inferred)"
      - name: prompts_detail
        description: "JSONB array of prompts: [{query_text, timestamp, pack_name, location, total_cards_in_pack}]"
      - name: explorer_prompt_count
        description: "Number of distinct Dextr prompts in this session"
      - name: cards_generated_detail
        description: "JSONB array of cards shown: [{card_name, card_id, category, rating, action (liked/disliked/unswiped), card_order}]"
      - name: total_cards_generated
        description: "Total cards presented across all packs in this session"
      - name: cards_liked
        description: "Cards swiped right / liked"
      - name: cards_disliked
        description: "Cards swiped left / disliked"
      - name: saves_detail
        description: "JSONB array of saves: [{card_name, card_id, category, board_name, saved_at}]"
      - name: shares_detail
        description: "JSONB array of shares: [{share_type, share_channel, shared_at, board_name, card_name, unique_viewers, total_interactions}]"
      - name: total_share_viewers
        description: "Total unique viewers across all shares in this session"
      - name: event_timeline
        description: "JSONB array of key events in chronological order: [{event, timestamp, card_name, card_id}]"
      - name: total_events
        description: "Count of key events (excludes impressions and minor events)"

  - name: fct_user_activation
    description: "User-level activation tracking. Each row is one user with their activation details. Activation is defined as first save, share, or AI-prompted save."
    columns:
      - name: user_id
        description: "Unique user identifier"
      - name: signup_date
        description: "User's original signup date"
      - name: activation_date
        description: "Date user first activated (saved, shared, or AI-prompted save). NULL if never activated."
      - name: cohort_week
        description: "Monday of the activation week for cohort grouping. NULL if never activated."
      - name: days_to_activation
        description: "Days between signup and first activation. NULL if never activated."
      - name: activation_type
        description: "First activation action type: save_prompted, saved, shared, or multiple"
      - name: first_activation_event
        description: "The specific event that first activated the user"
      - name: is_activated
        description: "Boolean flag: TRUE if user has activated"

  - name: fct_retention_by_cohort_week
    description: "Weekly cohort retention rates at D7/D30/D60/D90. One row per activation cohort week."
    columns:
      - name: cohort_week
        description: "Monday of activation week for cohort grouping"
      - name: cohort_size
        description: "Number of users who activated in this week"
      - name: mature_d7
        description: "Users with enough time elapsed to measure D7 retention"
      - name: mature_d30
        description: "Users with enough time elapsed to measure D30 retention"
      - name: mature_d60
        description: "Users with enough time elapsed to measure D60 retention"
      - name: mature_d90
        description: "Users with enough time elapsed to measure D90 retention"
      - name: retained_d7
        description: "Count of mature users who returned (prompted, saved, or shared) within 7 days of activation"
      - name: retained_d30
        description: "Count of mature users who returned (prompted, saved, or shared) within 30 days of activation"
      - name: retained_d60
        description: "Count of mature users who returned (prompted, saved, or shared) within 60 days of activation"
      - name: retained_d90
        description: "Count of mature users who returned (prompted, saved, or shared) within 90 days of activation"
      - name: retention_rate_d7
        description: "D7 retention rate as decimal (0-1). NULL if no mature users."
      - name: retention_rate_d30
        description: "D30 retention rate as decimal (0-1). NULL if no mature users."
      - name: retention_rate_d60
        description: "D60 retention rate as decimal (0-1). NULL if no mature users."
      - name: retention_rate_d90
        description: "D90 retention rate as decimal (0-1). NULL if no mature users."
      - name: cohort_save_prompted
        description: "Users in cohort whose first activation was AI-prompted save"
      - name: cohort_saved
        description: "Users in cohort whose first activation was save (no prompt)"
      - name: cohort_shared
        description: "Users in cohort whose first activation was share"
      - name: cohort_multiple
        description: "Users in cohort with multiple activation types"

  - name: fct_signup_to_activation_funnel
    description: "Weekly funnel from signup through activation. Tracks conversion at each step."
    columns:
      - name: signup_week
        description: "Week of signup for cohort trending"
      - name: total_signups
        description: "F0: Total users who signed up this week"
      - name: had_app_open_7d
        description: "F1: Users who had any event within 7 days of signup"
      - name: had_planning_initiated_7d
        description: "F2: Users who started planning (prompt, search, browse featured) within 7 days"
      - name: had_content_engagement_7d
        description: "F3: Users who engaged with content (swipe, view detail) within 7 days"
      - name: had_activation_7d
        description: "F4: Users who saved or shared within 7 days"
      - name: conversion_f0_to_f1
        description: "Conversion rate: signup → app open (decimal 0-1)"
      - name: conversion_f1_to_f2
        description: "Conversion rate: app open → planning initiated (decimal 0-1)"
      - name: conversion_f2_to_f3
        description: "Conversion rate: planning → content engagement (decimal 0-1)"
      - name: conversion_f3_to_f4
        description: "Conversion rate: engagement → activation (decimal 0-1)"
      - name: overall_activation_rate_7d
        description: "Overall conversion: signup → activation (decimal 0-1)"
      - name: activated_with_save
        description: "Users who activated with at least one save"
      - name: activated_with_share
        description: "Users who activated with at least one share"
      - name: activated_with_save_prompted
        description: "Users who activated via AI-prompted save"
      - name: activated_via_prompt
        description: "Users who activated through Dextr AI prompt"
      - name: activated_via_search
        description: "Users who activated through search"
      - name: activated_via_featured
        description: "Users who activated through featured content"
      - name: avg_time_to_activation_hours
        description: "Median hours from signup to first activation"

  - name: fct_user_retention
    description: "Comprehensive user-level retention fact table for CEO/executive reporting. One row per activated user with retention flags, engagement depth, and segmentation. Activated = ≥1 prompt OR ≥1 save OR ≥1 share. Retained = returned and did ≥1 prompt/save/share within window."
    columns:
      - name: user_id
        description: "Unique user identifier"
        tests:
          - not_null
          - unique
      - name: email
        description: "User email address"
      - name: username
        description: "User display name"
      - name: full_name
        description: "User full name"
      - name: signup_date
        description: "Date user created account"
        tests:
          - not_null
      - name: activation_date
        description: "Date user first activated (prompted, saved, or shared)"
        tests:
          - not_null
      - name: cohort_week
        description: "Monday of activation week for cohort grouping"
      - name: days_to_activation
        description: "Days from signup to first activation"
      - name: activation_type
        description: "First activation event type: save_prompted, saved, shared, or multiple"
      - name: user_type
        description: "Planner or Passenger segmentation"
      - name: is_mature_d7
        description: "TRUE if enough time has passed to measure D7 retention"
      - name: is_mature_d30
        description: "TRUE if enough time has passed to measure D30 retention"
      - name: is_mature_d60
        description: "TRUE if enough time has passed to measure D60 retention"
      - name: is_mature_d90
        description: "TRUE if enough time has passed to measure D90 retention"
      - name: retained_d7
        description: "TRUE if user returned (prompted, saved, or shared) within 7 days of activation"
      - name: retained_d30
        description: "TRUE if user returned (prompted, saved, or shared) within 30 days of activation"
      - name: retained_d60
        description: "TRUE if user returned (prompted, saved, or shared) within 60 days of activation"
      - name: retained_d90
        description: "TRUE if user returned (prompted, saved, or shared) within 90 days of activation"
      - name: sessions_d7
        description: "Number of sessions in first 7 days after activation"
      - name: sessions_d30
        description: "Number of sessions in first 30 days after activation"
      - name: sessions_d60
        description: "Number of sessions in first 60 days after activation"
      - name: sessions_d90
        description: "Number of sessions in first 90 days after activation"
      - name: sessions_post_activation
        description: "Total sessions after activation date (all time)"
      - name: total_sessions_to_date
        description: "Total sessions to date (all sessions including activation day)"
      - name: last_meaningful_activity_date
        description: "Most recent date the user had a prompt, save, or share"
      - name: saves_d7
        description: "Total saves in first 7 days after activation"
      - name: saves_d30
        description: "Total saves in first 30 days after activation"
      - name: shares_d7
        description: "Total shares in first 7 days after activation"
      - name: shares_d30
        description: "Total shares in first 30 days after activation"
      - name: total_prompts
        description: "All-time AI prompt count"
      - name: total_saves
        description: "All-time save count"
      - name: total_shares
        description: "All-time share count"
      - name: total_decks_created
        description: "All-time decks (boards) created"
      - name: total_multiplayer_sessions_created
        description: "All-time multiplayer sessions created"
      - name: total_referrals_given
        description: "All-time referrals given"
      - name: total_conversions
        description: "All-time conversion actions (opened_website, book_with_deck, etc.)"
      - name: days_active
        description: "Distinct days with any activity"
      - name: last_activity_date
        description: "Most recent activity date"
      - name: days_since_last_activity
        description: "Days since last activity (NULL if never active post-signup)"
      - name: is_churned
        description: "TRUE if no activity in the last 30 days"

  - name: fct_user_segments
    description: "User-level archetypes and segmentation. One row per non-test user. Combines activation, retention, session quality, and preference data. Answers: who are your best users, what % are one-and-done, top users by saves, planner vs passenger classification."
    columns:
      - name: user_id
        description: "Unique user identifier"
        tests:
          - not_null
          - unique
      - name: email
        description: "User email address"
      - name: username
        description: "User display name"
      - name: full_name
        description: "User full name"
      - name: signup_date
        description: "Date user signed up"
      - name: is_activated
        description: "TRUE if user ever prompted, saved, or shared"
      - name: activation_date
        description: "Date of first prompt, save, or share"
      - name: activation_week
        description: "Monday of activation week (THE cohort key for all segmentation)"
      - name: activation_trigger
        description: "What action first activated the user: first_prompt, first_save, or first_share"
      - name: days_since_signup
        description: "Days since account creation"
      - name: last_activity_date
        description: "Most recent activity date"
      - name: days_since_last_activity
        description: "Days since last activity (NULL if never active)"
      - name: total_sessions
        description: "All-time session count"
      - name: total_prompts
        description: "All-time Dextr AI prompt count"
      - name: total_swipes
        description: "All-time swipe count (left + right)"
      - name: total_saves
        description: "All-time save count"
      - name: total_shares
        description: "All-time share count"
      - name: total_boards_created
        description: "Non-default boards/decks created"
      - name: total_multiplayer_sessions
        description: "Multiplayer sessions created"
      - name: total_conversions
        description: "Conversion actions (opened_website, book_with_deck, etc.)"
      - name: total_referrals_given
        description: "Referrals given to other users"
      - name: user_archetype
        description: "Post-activation archetype: one_and_done, browser, saver, planner, power_planner. NULL if not activated."
        tests:
          - accepted_values:
              values: ['one_and_done', 'browser', 'saver', 'planner', 'power_planner']
      - name: is_planner
        description: "TRUE if user has saved AND shared at least once (lifetime)"
      - name: is_passenger
        description: "TRUE if activated but NOT a planner (has not both saved and shared)"
      - name: churn_risk
        description: "Churn risk level: high (14+ days inactive, <3 sessions), medium (7-14 days), low (active within 7 days)"
        tests:
          - accepted_values:
              values: ['high', 'medium', 'low']
      - name: is_churned
        description: "TRUE if no activity in 30+ days"
      - name: retained_d7
        description: "TRUE if returned within 7 days of activation"
      - name: retained_d30
        description: "TRUE if returned within 30 days of activation"
      - name: retained_d60
        description: "TRUE if returned within 60 days of activation"
      - name: referral_source
        description: "How user was acquired: organic or referral"
      - name: avg_saves_per_session
        description: "Average saves per session"
      - name: avg_session_duration_seconds
        description: "Average session duration in seconds"
      - name: prompt_to_save_rate
        description: "Ratio of saves to prompts (saves/prompts)"
      - name: swipe_to_save_rate
        description: "Ratio of saves to swipes (saves/swipes)"
      - name: sessions_with_save_pct
        description: "Percentage of sessions that had at least one save"
      - name: sessions_with_share_pct
        description: "Percentage of sessions that had at least one share"

  - name: fct_user_engagement_trajectory
    description: "Weekly engagement trajectory per user. One row per user per activity week. Tracks prompts, swipes, saves, shares, session quality, and cumulative metrics over time. Answers: engagement trends by cohort, time-to-first-save trends, session duration trends."
    columns:
      - name: user_id
        description: "Unique user identifier"
        tests:
          - not_null
      - name: activity_week
        description: "Monday of the activity week"
        tests:
          - not_null
      - name: activation_week
        description: "Monday of activation week (cohort key)"
      - name: weeks_since_activation
        description: "Weeks elapsed since activation"
      - name: sessions_count
        description: "Sessions in this week"
      - name: prompts_count
        description: "Dextr prompts in this week"
      - name: swipes_count
        description: "Card swipes in this week"
      - name: saves_count
        description: "Card saves in this week"
      - name: shares_count
        description: "Shares in this week"
      - name: conversions_count
        description: "Conversion actions in this week"
      - name: avg_session_duration_seconds
        description: "Average session duration in seconds for the week"
      - name: avg_time_to_first_save_seconds
        description: "Average seconds from session start to first save"
      - name: pct_sessions_with_save
        description: "% of sessions with at least one save"
      - name: pct_sessions_zero_actions
        description: "% of sessions with no saves and no shares (prompt and bounce)"
      - name: swipe_to_save_rate
        description: "Saves / swipes ratio for the week"
      - name: cumulative_sessions
        description: "Running total of sessions up to this week"
      - name: cumulative_saves
        description: "Running total of saves up to this week"
      - name: cumulative_shares
        description: "Running total of shares up to this week"
      - name: cards_viewed
        description: "Cards viewed (swipes + detail views) in this week"
      - name: avg_cards_per_session
        description: "Average cards interacted with per session"

  - name: fct_prompt_analysis
    description: "AI prompt-level performance analysis. One row per Dextr query. Tracks prompt sequencing, results quality, downstream outcomes, and user context. Answers: which prompts lead to 0 saves, re-prompting patterns, prompt refinement effects."
    columns:
      - name: query_id
        description: "Unique Dextr query identifier"
        tests:
          - not_null
          - unique
      - name: user_id
        description: "User who submitted the prompt"
      - name: query_text
        description: "The actual prompt text submitted"
      - name: query_date
        description: "Date prompt was submitted"
      - name: session_id
        description: "Session this prompt belongs to"
      - name: prompt_sequence_in_session
        description: "Ordinal position of this prompt in the session (1st, 2nd, etc.)"
      - name: is_refinement
        description: "TRUE if this is a 2nd+ prompt in the same session"
      - name: total_prompts_in_session
        description: "Total number of prompts in the same session"
      - name: cards_generated
        description: "Number of cards generated for this prompt"
      - name: cards_saved
        description: "Number of cards saved from this prompt's pack"
      - name: like_rate
        description: "Liked cards / acted-upon cards ratio"
      - name: save_rate
        description: "Saved cards / shown cards ratio"
      - name: zero_save_prompt
        description: "TRUE if no cards were saved from this prompt"
      - name: performance_category
        description: "Processing speed: fast (<3s), normal (3-8s), slow (>8s)"
        tests:
          - accepted_values:
              values: ['fast', 'normal', 'slow']
      - name: led_to_save
        description: "TRUE if the session had at least one save"
      - name: led_to_share
        description: "TRUE if the session had at least one share"
      - name: user_activation_week
        description: "User's activation week (cohort key)"
      - name: user_total_prior_prompts
        description: "How many prompts the user had made before this one"
      - name: user_retained_d30
        description: "TRUE if the user was retained at D30"
      - name: prompt_intent
        description: "Derived prompt intent category: date_night, group_outing, solo_explore, dining, drinks, culture, adventure, shopping, wellness, general"
        tests:
          - accepted_values:
              values: ['date_night', 'group_outing', 'solo_explore', 'dining', 'drinks', 'culture', 'adventure', 'shopping', 'wellness', 'general']
      - name: prompt_specificity
        description: "Prompt specificity level: high (specific venue/area), medium (category + area), low (vague)"
        tests:
          - accepted_values:
              values: ['high', 'medium', 'low']
      - name: location_mentioned
        description: "TRUE if a location was provided with the prompt"

  - name: fct_cohort_quality
    description: "Investor-ready cohort analysis. One row per activation week cohort. Shows retention rates, archetype distribution, first-session metrics, and leading indicators. Answers: which cohort had best D30 retention, churn patterns, referral vs organic quality."
    columns:
      - name: activation_week
        description: "Monday of activation week (cohort key)"
        tests:
          - not_null
          - unique
      - name: cohort_size
        description: "Number of users activated this week"
      - name: avg_days_signup_to_activation
        description: "Average days from signup to activation for this cohort"
      - name: one_and_done_count
        description: "Users with only 1 session who never returned"
      - name: one_and_done_pct
        description: "% of cohort that was one-and-done"
      - name: planner_count
        description: "Users classified as planner or power_planner"
      - name: planner_pct
        description: "% of cohort that became planners"
      - name: retention_rate_d7
        description: "D7 retention rate (0-1) for mature users"
      - name: retention_rate_d30
        description: "D30 retention rate (0-1) for mature users"
      - name: retention_rate_d60
        description: "D60 retention rate (0-1) for mature users"
      - name: avg_first_session_saves
        description: "Average saves in the first session"
      - name: pct_activated_in_first_session
        description: "% who activated on their first day"
      - name: pct_churned_with_zero_saves
        description: "% of churned users who never saved"
      - name: avg_sessions_first_week
        description: "Average sessions in first 7 days post-activation"
      - name: pct_multi_day_first_week
        description: "% with activity on 2+ days in first week"
      - name: organic_count
        description: "Users acquired organically"
      - name: referral_count
        description: "Users acquired via referral"
      - name: organic_retention_d30
        description: "D30 retention for organic users (0-1)"
      - name: referral_retention_d30
        description: "D30 retention for referred users (0-1)"
      - name: avg_first_session_swipes
        description: "Average card swipes in the first session"

  - name: fct_place_performance
    description: "Place/card-level performance metrics. One row per place in the content catalog. Tracks impressions, swipes, saves, shares, conversions, and rates. Answers: best/worst performing cards, category comparison, featured vs AI content."
    columns:
      - name: card_id
        description: "Unique card identifier (deck_sku for post-Gemini, integer for legacy)"
        tests:
          - not_null
          - unique
      - name: place_name
        description: "Name of the place/card"
      - name: category
        description: "Place category (Dining, Drinks, etc.)"
      - name: total_impressions
        description: "Total swipes (left + right) on this card"
      - name: total_saves
        description: "Total saves of this card"
      - name: total_shares
        description: "Total shares of this card"
      - name: right_swipe_rate
        description: "Right swipes / total swipes (0-1)"
      - name: save_rate
        description: "Saves / impressions (0-1)"
      - name: share_rate
        description: "Shares / impressions (0-1)"
      - name: conversion_rate
        description: "Conversion actions / impressions (0-1)"
      - name: viral_score
        description: "Shares / saves ratio — higher means more viral"
      - name: packs_appeared_in
        description: "Number of distinct packs this card appeared in"
      - name: impressions_last_7d
        description: "Impressions in last 7 days"
      - name: saves_last_7d
        description: "Saves in last 7 days"
      - name: impressions_last_30d
        description: "Impressions in last 30 days"
      - name: saves_last_30d
        description: "Saves in last 30 days"
      - name: place_id
        description: "Resolved places.place_id integer from int_place_resolver. NULL for legacy cards."
      - name: total_detail_views
        description: "Total detail/place_detail views for this card"
      - name: total_book_clicks
        description: "Total book button clicks and book_with_deck actions"
      - name: neighborhood
        description: "First component of formatted_address (approximate neighborhood)"

  - name: fct_pack_performance
    description: "Dextr AI pack-level analytics. One row per pack. Tracks card generation, engagement, saves, and session outcomes. Answers: which prompts produce best packs, save rates by pack, shortlist completion."
    columns:
      - name: pack_id
        description: "Unique pack identifier"
        tests:
          - not_null
          - unique
      - name: query_id
        description: "Dextr query that generated this pack"
      - name: query_text
        description: "The prompt text that generated this pack"
      - name: total_cards_generated
        description: "Cards generated in this pack"
      - name: cards_liked
        description: "Cards swiped right"
      - name: cards_saved
        description: "Cards saved from this pack"
      - name: like_rate
        description: "Liked / acted-upon ratio (0-1)"
      - name: save_rate
        description: "Saved / shown ratio (0-1)"
      - name: has_shortlist
        description: "TRUE if 3+ cards were saved"
      - name: led_to_save
        description: "TRUE if the session had a save"
      - name: led_to_share
        description: "TRUE if the session had a share"
      - name: share_rate
        description: "Share events / shown cards ratio"
      - name: prompt_intent_category
        description: "Derived prompt intent: date_night, group_outing, solo_explore, dining, drinks, culture, adventure, general"
        tests:
          - accepted_values:
              values: ['date_night', 'group_outing', 'solo_explore', 'dining', 'drinks', 'culture', 'adventure', 'general']

  - name: fct_conversion_signals
    description: "Booking intent and monetisation readiness signals. One row per conversion action (opened_website, book_with_deck, click_directions, click_phone). Answers: how many saves lead to clicks, which categories convert, prompt-initiated vs organic."
    columns:
      - name: action_id
        description: "Sequential action identifier"
        tests:
          - not_null
          - unique
      - name: user_id
        description: "User who performed the conversion action"
      - name: card_id
        description: "Card/place the action was performed on"
      - name: place_name
        description: "Name of the place"
      - name: place_category
        description: "Category of the place"
      - name: action_type
        description: "Type of conversion: opened_website, book_with_deck, click_directions, click_phone"
        tests:
          - not_null
          - accepted_values:
              values: ['opened_website', 'book_with_deck', 'click_directions', 'click_phone']
      - name: action_date
        description: "Date of the conversion action"
      - name: was_saved_first
        description: "TRUE if user saved this card before converting"
      - name: time_from_save_to_conversion_minutes
        description: "Minutes between last save and conversion"
      - name: was_prompt_initiated
        description: "TRUE if conversion happened in a prompt session"
      - name: prompt_text
        description: "The Dextr query text if this conversion was in a prompt-initiated session"

  - name: fct_viral_loop
    description: "Social sharing and viral loop analytics. One row per share link. Tracks reach, viewer behavior, and signup conversions. Answers: what % of shares get opened, K-factor, share effectiveness by user type."
    columns:
      - name: share_link_id
        description: "Unique share link identifier"
        tests:
          - not_null
          - unique
      - name: sharer_user_id
        description: "User who created the share"
      - name: sharer_archetype
        description: "Archetype of the sharer (from fct_user_segments)"
      - name: share_type
        description: "Type of share: board, card, multiplayer"
      - name: share_channel
        description: "Channel used to share"
      - name: shared_at
        description: "Timestamp of share creation"
      - name: unique_viewers
        description: "Distinct viewers who opened the share"
      - name: unique_authenticated_viewers
        description: "Viewers with accounts"
      - name: unique_anonymous_viewers
        description: "Viewers without accounts"
      - name: viewers_who_signed_up
        description: "Viewers who created accounts after viewing"
      - name: signup_conversion_rate
        description: "Signups / viewers (0-1)"
      - name: effective_k_factor
        description: "Signups generated per share"
      - name: time_to_first_view_minutes
        description: "Minutes from share creation to first view"
      - name: total_views
        description: "Total view interactions on this share link"
      - name: viewers_who_saved
        description: "Viewers who performed a save action after viewing"
      - name: time_to_first_signup_minutes
        description: "Minutes from share creation to first signup"
